#!/bin/bash
#############################################################################
# Single jar, maven build,deploy jvm control helper script.
# For multiple jar files you need some extra loops but this is the basic idea.
#############################################################################

# Be nice on production
renice 19 $$ > /dev/null 2> /dev/null

# prod path | app name
app_name="psauxit.jar"
prod_path="$HOME/psauxitwebtools"
preprod_path="$HOME/webnettools"

# my jar is exist
find_prod_app () {
  prod_app=`find "${prod_path:?}/" -name \*"${app_name}" -print0 | tr -d '\0' 2>/dev/null`
}

# Set color
setup_terminal () {
  green=""; red=""; reset=""; cyan=""; magenta=""; yellow=""; TPUT_RESET="";
  TPUT_GREEN=""; TPUT_CYAN=""; TPUT_DIM=""; TPUT_BOLD=""; m_tab='  '; BC=$'\e[32m'
  EC=$'\e[0m'; TPUT_BGRED=""; TPUT_WHITE=""; TPUT_BGGREEN=""
  test -t 2 || return 1
  if command -v tput > /dev/null 2>&1; then
    if [[ $(($(tput colors 2> /dev/null))) -ge 8 ]]; then
      green="$(tput setaf 2)"; red="$(tput setaf 1)"; reset="$(tput sgr0)"; cyan="$(tput setaf 6)"
      magenta="$(tput setaf 5)"; yellow="$(tput setaf 3)"; TPUT_RESET="$(tput sgr 0)"
      TPUT_GREEN="$(tput setaf 2)"; TPUT_CYAN="$(tput setaf 6)"; TPUT_DIM="$(tput dim)"
      TPUT_BOLD="$(tput bold)"; TPUT_BGRED="$(tput setab 1)"; TPUT_RESET="$(tput sgr 0)"
      TPUT_WHITE="$(tput setaf 7)"; TPUT_BGGREEN="$(tput setab 2)"; TPUT_RESET="$(tput sgr 0)"
    fi
  fi
  return 0
}
setup_terminal || echo > /dev/null

# wait for process exit code
my_wait () {
  local my_pid=$!
  local result
  # Force kill bg process if script exits
  trap "kill -9 $my_pid 2>/dev/null" EXIT
  # Wait stylish while process is alive
  spin='-\|/'
  mi=0
  while kill -0 $my_pid 2>/dev/null # (ps | grep $my_pid) is alternative
  do
    mi=$(( (mi+1) %4 ))
    printf "\r${m_tab}${green}[ ${spin:$mi:1} ]${magenta} ${1}${reset}"
    sleep .1
  done
  # Get bg process exit code
  wait $my_pid
  [[ $? -eq 0 ]] && result=ok
  # Need for tput cuu1
  echo ""
  # Reset trap to normal exit
  trap - EXIT
  # Return status of function according to bg process status
  [[ "${result}" ]] && return 0
  return 1
}

fatal () {
  printf >&2 "\n${m_tab}%s ABORTED %s %s \n\n" "${TPUT_BGRED}${TPUT_WHITE}${TPUT_BOLD}" "${TPUT_RESET}" "${*}"
  exit 1
}

replace_suc () {
  tput cuu 1
  echo "${m_tab}${TPUT_BOLD}${green}[ âœ“ ] ${cyan}${1}${reset}"
}

replace_fail () {
  tput cuu 1
  echo "${m_tab}${TPUT_BOLD}${red}[ x ] ${cyan}${1}${reset}"
}

# deployment process
deploy () {
  local preprod_app=`find "${preprod_path:?}/" -name \*-runner.jar -print0 | tr -d '\0' 2>/dev/null`

  # check this is a clean deploy
  if [[ -d "${prod_path:?}" ]]; then
     find_prod_app
     [[ $prod_app ]] && clean=0 || clean=1
  else
    clean=1
  fi

  # Start deployment
  if [[ -d "${preprod_path:?}" ]]; then
    if [[ $preprod_app ]]; then
      if [[ "${clean}" -eq 0 ]]; then
        if [[ "$(md5sum "${preprod_app}" | awk '{print $1}')" != "$(md5sum "${prod_app}" | awk '{print $1}')" ]]; then
          { rm -rf "${prod_path:?}"; mkdir -p "${prod_path}"/lib; cp "${preprod_app}" "${prod_path}"/"${prod_app##*/}"; cp -r "${preprod_path}"/target/lib/* "${prod_path}"/lib/; } >/dev/null 2>&1
        else
          echo "Application up to date. Deployment skipped!"
          return 1
        fi
      else
        { mkdir -p "${prod_path}"/lib; cp "${preprod_app}" "${prod_path}"/"${app_name}"; cp -r "${preprod_path}"/target/lib/* "${prod_path}"/lib/; find_prod_app; } >/dev/null 2>&1
      fi
    else
      echo "Cannot start deployment process, deployment jar cannot found!"
      return 1
    fi
  else
    echo "Cannot start deployment process, preprod path not found!"
    return 1
  fi
  return 0
}

# Build jar via maven
mvn_build () {
  if [[ -d "${preprod_path:?}" ]]; then
    cd "${preprod_path}"
    echo ""
    mvn clean &>/dev/null &
    my_wait "Removing old.." && replace_suc "Completed successfully!" || { replace_fail "Failed"; fatal "QUIT"; }
    mvn package &>/dev/null &
    my_wait "Building application.." && replace_suc "Completed successfully! Ready to deployment!" || { replace_fail "Failed!"; fatal "QUIT"; }
    echo ""
  else
    fatal "Preprod path not exist!"
  fi
}


# Application global vars
global_vars () {
  PORT=8080
  export PATH=
  export AVAILABLE_TOOLS=
  export RATE_LIMIT=1
  export CA_DIR=
  export PORT=8080
  export JAVA_OPTIONS="-Dquarkus.http.host=127.0.0.1 -Djava.util.logging.manager=org.jboss.logmanager.LogManager -Dquarkus.http.port=${PORT}"
  export INTRO_TEXT='psauxit.com'
}

# Test application is working after (re)start in background for 5 sec
# To:do add 'try loop' if not suc after 5 sec
nohup_java () {
  startwait=5
  pid=$!
  for i in $(seq $startwait); do
    if ! kill -0 $pid 2>/dev/null; then
      wait $!
      exitcode=$?
      echo "Application cannot (re)started, EXITCODE:$exitcode" >&2
      break
    fi
    sleep 1
  done
  if kill -0 $pid; then
    echo "Application (re)started successfully!"
  fi
}

# run in background
my_run () {
  nohup java -jar "${prod_app}" >/dev/null 2>&1 &
}

# run in foreground
my_run_f () {
  java -jar "${prod_app}"
}

# stop jvm
stop_jvm () {
  if kill -9 $(ps aux | grep -v grep | grep "${app_name}" | awk '{print $2}') >/dev/null 2>&1; then
    echo "Application stopped!"
  else
    echo "Application already stopped!"
  fi
}

# start jvm
start_jvm () {
  if ! ps aux | grep -v grep | grep "${app_name}" >/dev/null 2>&1; then
    find_prod_app
    [[ $prod_app ]] && { global_vars; my_run; nohup_java; } || echo "App not found. Cannot start application!"
  else
    echo "Application already running!"
  fi
}

# restart jvm
restart_jvm () {
  stop_jvm
  start_jvm
}

# carry process to foreground
run_foreground () {
  stop_jvm
  find_prod_app
  [[ $prod_app ]] && { global_vars; my_run_f; } || echo "App not found. Cannot start application!"
}

help () {
  echo -e "\n${m_tab}${cyan}# Script Help"
  echo -e "${m_tab}# ----------------------------------------------------"
  echo -e "${m_tab}#${m_tab}--start              start jvm"
  echo -e "${m_tab}#${m_tab}--stop               stop jvm"
  echo -e "${m_tab}#${m_tab}--restart            restart jvm"
  echo -e "${m_tab}#${m_tab}--foreground         start jvm on foreground"
  echo -e "${m_tab}#${m_tab}--deploy             start deployment"
  echo -e "${m_tab}#${m_tab}--build              build application"
  echo -e "${m_tab}#${m_tab}--help               display help"
  echo -e "${m_tab}# ----------------------------------------------------${reset}\n"
}

deployment () {
  # Start or restart application(deployment)
  if deploy; then
    # Restart application
    [[ $clean -eq 0 ]] && echo "New application version found, deployment completed successfully" || echo "Clean deployment completed successfully"
    echo "Trying to (re)start application..."
    kill -9 $(ps aux | grep -v grep | grep "${prod_app##*/}" | awk '{print $2}') >/dev/null 2>&1
    global_vars
    my_run
    nohup_java
  elif ! ps aux | grep -v grep | grep "${prod_app##*/}" >/dev/null 2>&1; then
    echo "Application is not working currently.."
    echo "Trying to start application..."
    global_vars
    my_run
    nohup_java
  else
    echo "Application is running."
  fi
}

# set script arguments
case "$@" in
  --start      ) start_jvm; exit ;;
  --stop       ) stop_jvm; exit ;;
  --restart    ) restart_jvm; exit ;;
  --foreground ) run_foreground; exit ;;
  --deploy     ) deployment; exit ;;
  --build      ) mvn_build; exit ;;
  *            ) help; exit ;;
esac
