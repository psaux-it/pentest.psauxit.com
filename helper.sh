#!/bin/bash
# Helper script for pentest.psauxit.com

lavg=$(< /proc/loadavg awk '{print $1}')
lavgi=$(echo "100 * $lavg" | bc | cut -f1 -d".")
mf=$(free -m | sed -n '2p' | awk '{print $7}')
np=$(nproc); mcl=$(echo "100 * $np" | bc );

if [[ "${lavgi}" -gt "${mcl}" || "${mf}" -lt 756 ]]; then
  echo ""
  echo "################################################################################"
  echo "System is busy now. Your request hasn't been queued now. Please try again later!"
  echo "################################################################################"
  toilet -f mono12 PSAUXIT
  exit 1
fi

echo ""

if [[ $1 == dig ]]; then
  if [[ $# -gt 4 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  fi
  if [[ $# -eq 2 ]]; then
    dig ${@: -1} any
  elif [[ $3 == DMARC ]]; then
    dig TXT _dmarc.${@: -1}
  elif [[ $3 == SPF ]]; then
    dig TXT ${@: -1}
  elif [[ $3 == MX ]]; then
    dig MX ${@: -1}
  elif [[ $3 == NS ]]; then
    dig NS ${@: -1}
  elif [[ $3 == A ]]; then
    dig A ${@: -1}
  elif [[ $3 == REVERSE ]]; then
    dig -x $(dig A ${@: -1} | grep -v -e "^$\|^;" | awk '{print $NF}') | grep -v -e "^$\|^;" | awk '{print $5}' | sed 's/.$//'
  fi
elif [[ $1 == dnsrecon ]]; then
   if [[ $# -gt 4 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  fi
  if [[ $# -eq 2 ]]; then
    dnsrecon.py -d ${@: -1} --threads 1
  elif [[ $3 == AXFR ]]; then
    dnsrecon.py -d ${@: -1} -t zonewalk --threads 1
  elif [[ $3 == ZONEWALK ]]; then
    dnsrecon.py -d ${@: -1} -t axfr --threads 1
  elif [[ $3 == BRUTE ]]; then  
    dnsrecon.py -d ${@: -1} -D /dnsrecon/subdomains-top1mil-20000.txt -t brt --threads 1
  fi
elif [[ $1 == wpscan ]]; then
  if [[ $# -gt 10 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  fi
  if [[ $# -eq 2 ]]; then
    wpscan --url ${@: -1} -e vp,vt,u --random-user-agent --ignore-main-redirect -t 1
  else
    args=("$@")
    for n in "${!args[@]}"; do
      [[ ${args[n]} == timeout ]] && opt_1="--connect-timeout ${args[n+1]}"
      [[ ${args[n]} == request ]] && opt_2="--request-timeout ${args[n+1]}"
      [[ ${args[n]} == DISABLE ]] && opt_3="--disable-tls-checks"
    done
  
    for i in $@; do
      if [[ $i == MIXED ]]; then
        wpscan --url ${@: -1} --detection-mode mixed -e vp,vt,u --random-user-agent --ignore-main-redirect -t 1 $opt_1 $opt_2 $opt_3
      elif [[ $i == PASSIVE ]]; then
        wpscan --url ${@: -1} --detection-mode passive -e vp,vt,u --random-user-agent --ignore-main-redirect -t 1 $opt_1 $opt_2 $opt_3
      elif [[ $i == AGGRESSIVE ]]; then
        wpscan --url ${@: -1} --detection-mode aggressive -e vp,vt,u --random-user-agent --ignore-main-redirect -t 1 $opt_1 $opt_2 $opt_3
      fi
    done
  fi
elif [[ $1 == amass ]]; then
  if [[ $# -gt 4 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  fi
  if [[ $# -eq 2 ]]; then
    amass enum -d ${@: -1} -brute -src -ip -min-for-recursive 2
  elif [[ $3 == ACTIVE ]]; then
    amass enum -active -d ${@: -1} -brute -src -ip -min-for-recursive 2
  elif [[ $3 == PASSIVE ]]; then
    amass enum -d ${@: -1} -brute -src -ip -min-for-recursive 2
  fi
elif [[ $1 == ddec ]]; then
  if [[ $# -gt 6 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  fi
  ddec.py $2 $3 $4 $5 $6
elif [[ $1 == rustscan ]]; then
  if [[ $# -gt 4 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  fi
  if [[ $# -eq 2 ]]; then
    rustscan -b 600 -a ${@: -1}
  elif [[ $3 == ENABLE ]]; then
     rustscan -b 600 -a ${@: -1} -- -A -sC -sV -T4
  fi
elif [[ $1 == traceroot ]]; then
  if [[ $# -gt 3 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  else
    traceroot ${@: -1}
  fi
elif [[ $1 == hostlinux ]]; then
  if [[ $# -gt 3 ]]; then
    echo "Bad argument. Please check target input. Supply only domain, hostname or IP address that tool needs without whitespaces or any extra argument"
    toilet -f mono12 PSAUXIT
    exit 1
  else
    host ${@: -1}
  fi
fi
